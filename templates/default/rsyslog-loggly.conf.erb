# This file was generated by Chef

# Setup disk assisted queues
$WorkDirectory <%= node['rsyslog']['working_dir'] %> # where to place spool files
$ActionQueueFileName fwdRule1     # unique name prefix for spool files
$ActionQueueMaxDiskSpace 1g       # 1gb space limit (use as much as possible)
$ActionQueueSaveOnShutdown on     # save messages to disk on shutdown
$ActionQueueType LinkedList       # run asynchronously
$ActionResumeRetryCount -1        # infinite retries if host is down

# RsyslogGnuTLS
$DefaultNetstreamDriverCAFile <%= @crt_file %>
$ActionSendStreamDriver gtls
$ActionSendStreamDriverMode 1
$ActionSendStreamDriverAuthMode x509/name
$ActionSendStreamDriverPermittedPeer *.loggly.com

<%- if supports_function_syntax? -%>
template(name="LogglyFormat" type="string" string="<%%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [<%= @token %>@41058 <%= @tags %>] %msg%\n")
# Send messages to Loggly over TCP using the template.
action(type="omfwd" protocol="tcp" target="<%= node['loggly']['rsyslog']['host'] %>" port="<%= node['loggly']['rsyslog']['port'] %>" template="LogglyFormat")
<%- else -%>
$template LogglyFormat,"<%%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [<%= @token %>@41058 <%= @tags %>] %msg%\n"
*.* @@<%= node['loggly']['rsyslog']['host'] %>:<%= node['loggly']['rsyslog']['port'] %>;LogglyFormat
<%- end -%>
